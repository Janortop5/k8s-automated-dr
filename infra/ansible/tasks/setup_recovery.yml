- name: Generate secure webhook token with timestamp
  set_fact:
    webhook_token: "{{ ansible_date_time.epoch }}-{{ 999999999 | random }}-{{ ansible_hostname | hash('sha256') | truncate(8, true, '') }}"
      
- name: Create webhook job with proper Generic Webhook Trigger configuration
  uri:
    url: "https://{{ jenkins_live_domain }}/scriptText"
    method: POST
    user: "{{ jenkins_username }}"
    password: "{{ jenkins_api_token }}"
    force_basic_auth: yes
    headers:
      Jenkins-Crumb: "{{ jenkins_crumb.json.crumb }}"
    body_format: form-urlencoded
    body:
      script: |
        import jenkins.model.*
        import org.jenkinsci.plugins.workflow.job.WorkflowJob
        import org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition
        import hudson.plugins.git.GitSCM
        import hudson.plugins.git.BranchSpec
        import hudson.plugins.git.UserRemoteConfig
        import org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty
        import org.jenkinsci.plugins.gwt.GenericTrigger
        import org.jenkinsci.plugins.gwt.GenericVariable
        import org.jenkinsci.plugins.gwt.GenericRequestVariable
        import org.jenkinsci.plugins.gwt.GenericHeaderVariable
        import hudson.model.StringParameterDefinition
        import hudson.model.ParametersDefinitionProperty
        import hudson.model.BooleanParameterDefinition
        
        def jenkins = Jenkins.instance
        def jobName = "{{ jenkins_job_name | default('k8s-automated-dr') }}"
        
        // Delete existing job if it exists
        def existingJob = jenkins.getItem(jobName)
        if (existingJob != null) {
            existingJob.delete()
            println("üóëÔ∏è  Deleted existing job: ${jobName}")
        }
        
        // Create new pipeline job
        def job = jenkins.createProject(WorkflowJob, jobName)
        job.description = "Automated DR Pipeline with Enhanced Webhook Trigger"
        
        // Add parameters to the job
        def parameterDefinitions = [
            new BooleanParameterDefinition('DEPLOY_STANDBY_ONLY', false, 'Deploy standby environment only'),
            new BooleanParameterDefinition('DESTROY_AFTER_APPLY', false, 'Destroy resources after apply'),
            new BooleanParameterDefinition('SKIP_TESTS', false, 'Skip running tests'),
            new StringParameterDefinition('TRIGGERED_BY', 'manual', 'Source of trigger'),
            new StringParameterDefinition('ALERT_TYPE', 'cpu', 'Type of alert that triggered this job')
        ]
        
        def parametersProperty = new ParametersDefinitionProperty(parameterDefinitions)
        job.addProperty(parametersProperty)
        
        // Configure Git SCM
        def userRemoteConfigs = [new UserRemoteConfig("{{ git_repo_url }}", "git-credentials")]
        def gitSCM = new GitSCM(userRemoteConfigs)
        gitSCM.branches = [new BranchSpec("{{ git_branch | default('*/main') }}")]
        
        // Set pipeline definition from SCM
        def flowDefinition = new CpsScmFlowDefinition(gitSCM, "{{ jenkinsfile_path | default('Jenkinsfile') }}")
        flowDefinition.lightweight = true
        job.definition = flowDefinition
        
        // Configure Generic Webhook Trigger with detailed variable extraction
        def genericVariables = [
            new GenericVariable("DEPLOY_STANDBY_ONLY", "\$.deploy_standby_only", "JSONPath", "false"),
            new GenericVariable("DESTROY_AFTER_APPLY", "\$.destroy_after_apply", "JSONPath", "false"), 
            new GenericVariable("SKIP_TESTS", "\$.skip_tests", "JSONPath", "false"),
            new GenericVariable("TRIGGERED_BY", "\$.triggered_by", "JSONPath", "webhook"),
            new GenericVariable("ALERT_TYPE", "\$.alert_type", "JSONPath", "cpu"),
            new GenericVariable("ALERT_VALUE", "\$.alert_value", "JSONPath", "0"),
            new GenericVariable("TIMESTAMP", "\$.timestamp", "JSONPath", "")
        ]
        
        def genericRequestVariables = [
            new GenericRequestVariable("REQUEST_METHOD", "REQUEST_METHOD")
        ]
        
        def genericHeaderVariables = [
            new GenericHeaderVariable("CONTENT_TYPE", "Content-Type")
        ]
        
        def genericTrigger = new GenericTrigger(
            genericVariables,
            "",  // regexFilter - empty means accept all
            "",  // regexFilterText  
            "{{ webhook_token }}",  // token
            true,  // printContributedVariables
            true,  // printPostContent
            false, // silentResponse
            false, // shouldNotFlatten
            genericRequestVariables,
            genericHeaderVariables
        )
        
        def triggerProperty = new PipelineTriggersJobProperty([genericTrigger])
        job.addProperty(triggerProperty)
        
        // Save the job
        job.save()
        
        println("‚úÖ Enhanced pipeline job '${jobName}' created successfully")
        println("üîó Webhook URL: https://{{ jenkins_live_domain }}/generic-webhook-trigger/invoke?token={{ webhook_token }}")
    status_code: [200]
    validate_certs: no
  register: job_creation_result


- name: Store webhook configuration in Vault
  shell: |
    docker exec -i tf_vault sh << EOF
    export VAULT_ADDR="http://127.0.0.1:8200"
    vault login {{ remote_vault_token }}
    vault kv put secret/jenkins_webhook -<<EOJSON
    {
      "webhook_token": "{{ webhook_token }}",
      "webhook_url": "https://{{ jenkins_live_domain }}/job/{{ jenkins_job_name | default('k8s-automated-dr') }}/job/main/buildWithParameters",
      "jenkins_job_url": "https://{{ jenkins_live_domain }}/job/{{ jenkins_job_name | default('k8s-automated-dr') }}/job/main/",
      "trigger_domain": "https://trigger.{{ jenkins_live_domain }}/trigger"
    }
    EOJSON
    EOF

- name: Test webhook token functionality
  uri:
    url: "https://{{ jenkins_live_domain }}/job/{{ jenkins_job_name | default('k8s-automated-dr') }}/job/main/buildWithParameters"
    method: POST
    headers:
      Content-Type: "application/json"
    body_format: json
    body:
      deploy_standby_only: false
      destroy_after_apply: false
      skip_tests: true
      triggered_by: "ansible-test"
      alert_type: "test"
      timestamp: "{{ ansible_date_time.iso8601 }}"
    status_code: [200, 201]
  register: webhook_test
  ignore_errors: true

- name: Display webhook test results
  debug:
    msg:
      - "üß™ Webhook Test Results:"
      - "Status: {{ webhook_test.status | default('Failed') }}"
      - "Token: {{ webhook_token }}"
      - "URL: https://{{ jenkins_live_domain }}/job/{{ jenkins_job_name | default('k8s-automated-dr') }}/job/main/"

- name: Create application user
  user:
    name: "{{ app_user }}"
    system: true
    shell: /bin/bash
    home: "{{ app_dir }}"
    create_home: no

- name: Create application directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0755'

- name: Create logs directory
  file:
    path: "{{ app_dir }}/logs"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0755'

- name: Add NodeSource Node.js 18.x APT repository
  shell: curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
  args:
    executable: /bin/bash

- name: Install Node.js 18 and npm
  apt:
    name: nodejs
    state: present
    update_cache: yes

- name: Install Redis
  apt:
    name: redis-server
    state: present
    update_cache: yes
    
- name: Synchronize trigger application files
  synchronize:
    src: "{{ playbook_dir }}/files/trigger/"
    dest: "{{ app_dir }}/"
    recursive: yes

- name: Set ownership of application files
  file:
    path: "{{ app_dir }}"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    recurse: yes

- name: Install Node.js dependencies
  npm:
    path: "{{ app_dir }}/."
    state: present
    production: true
  become_user: "{{ app_user }}"

- name: Ensure dotenv is installed
  npm:
    name: dotenv
    path: "{{ app_dir }}"
    state: present
  become_user: "{{ app_user }}"

- name: Create .env file from template
  template:
    src: "{{ playbook_dir }}/templates/nodejs-trigger.env.j2"
    dest: "{{ app_dir }}/.env"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: "0600"  # Secure permissions for sensitive data
  notify:
    - restart {{ app_name }}

- name: Install systemd unit for nodejs-trigger service
  ansible.builtin.copy:
    dest: /etc/systemd/system/{{ app_name }}.service
    mode: "0644"
    content: |
      [Unit]
      Description=Node.js Jenkins Trigger Service
      Documentation=https://github.com/your-org/nodejs-trigger
      After=network.target redis.service
      Wants=redis.service

      [Service]
      Type=simple
      User={{ app_user }}
      Group={{ app_user }}
      WorkingDirectory={{ app_dir }}
      Environment=NODE_ENV=production
      EnvironmentFile={{ app_dir }}/.env
      ExecStart=/usr/bin/node {{ app_dir }}/index.js
      ExecReload=/bin/kill -HUP $MAINPID
      Restart=always
      RestartSec=5
      StandardOutput=journal
      StandardError=journal
      SyslogIdentifier={{ app_name }}

      # Security settings
      NoNewPrivileges=true
      PrivateTmp=true
      ProtectSystem=strict
      ProtectHome=true
      ReadWritePaths={{ app_dir }}

      # Resource limits
      LimitNOFILE=65536
      LimitNPROC=4096

      [Install]
      WantedBy=multi-user.target
  notify:
    - reload systemd
    - restart {{ app_name }}
    
- name: Enable and start Node.js service
  systemd:
    name: "{{ app_name }}"
    enabled: true
    state: started
    daemon_reload: true

- name: Check service status
  systemd:
    name: "{{ app_name }}"
    state: started
  register: service_status

- name: Display service information
  debug:
    msg:
      - "‚úÖ Node.js Trigger Service Setup Complete"
      - "Service: {{ app_name }}"
      - "Status: {{ service_status.status.ActiveState }}"
      - "Port: {{ service_port }}"
      - "Directory: {{ app_dir }}"
      - "User: {{ app_user }}"
      - ""
      - "üîó Endpoints:"
      - "  Health Check: http://trigger.{{ jenkins_live_domain }}/health"
      - "  Trigger: POST http://trigger.{{ jenkins_live_domain }}/trigger"
      - "  Queue Status: http://trigger.{{ jenkins_live_domain }}/queue/status"
      - ""
      - "üìù Test with:"
      - "curl -X POST http://trigger.{{ jenkins_live_domain }}/trigger \\"
      - "  -H 'Content-Type: application/json' \\"
      - "  -d '{\"parameters\":{\"deploy_standby_only\":\"true\"}}'"

# ---------------------------------------------------------------------------
# 1. Issue new cert for trigger.<ip>.<suffix>
# ---------------------------------------------------------------------------
- name: Attempt certbot for trigger.<ip>.<suffix>
  shell: |
    DOMAIN="trigger.{{ jenkins_public_ip }}.{{ item }}"
    if [ ! -f "/etc/letsencrypt/live/${DOMAIN}/fullchain.pem" ]; then
      certbot certonly --nginx --non-interactive --agree-tos \
              --email {{ letsencrypt_email }} \
              --redirect \
              -d "${DOMAIN}"
    fi
  args:
    executable: /bin/bash
  register: certbot_trigger_attempts
  failed_when: false
  loop: "{{ public_suffixes }}"
  loop_control:
    label: "trigger.{{ jenkins_public_ip }}.{{ item }}"
  notify: reload nginx

- name: Record successful domain for nodejs-trigger
  set_fact:
    certbot_obtained: true
    trigger_live_domain: "{{ item.item | ternary('trigger.' ~ jenkins_public_ip ~ '.' ~ item.item, '') }}"
  when: item.rc is defined and item.rc == 0
  loop: "{{ certbot_trigger_attempts.results }}"

- name: Fail if cert not obtained for nodejs-trigger
  fail:
    msg: >
      Could not obtain a certificate for trigger.<ip>.<suffix>. Tried:
      {{ public_suffixes | map('regex_replace', '(.*)', 'trigger.' ~ jenkins_public_ip ~ '.\\1') | join(', ') }}
  when: trigger_live_domain is not defined

- name: Install HTTPS vhost for nodejs-trigger
  copy:
    dest: /etc/nginx/sites-available/nodejs-ssl.conf
    mode: "0644"
    content: |
      server {
          listen 443 ssl http2;
          server_name {{ trigger_live_domain }};

          ssl_certificate     /etc/letsencrypt/live/{{ trigger_live_domain }}/fullchain.pem;
          ssl_certificate_key /etc/letsencrypt/live/{{ trigger_live_domain }}/privkey.pem;

          ssl_protocols       TLSv1.2 TLSv1.3;
          ssl_session_cache   shared:SSL:10m;
          ssl_prefer_server_ciphers on;

          location / {
              proxy_pass http://127.0.0.1:{{ service_port }};
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
          }

          location /health {
              proxy_pass http://127.0.0.1:{{ service_port }};
              access_log off;
          }

          access_log /var/log/nginx/{{ app_name }}_access.log;
          error_log /var/log/nginx/{{ app_name }}_error.log;
      }
  notify: reload nginx

- name: Install HTTP‚ÜíHTTPS redirect for nodejs-trigger
  copy:
    dest: /etc/nginx/sites-available/nodejs-http.conf
    mode: "0644"
    content: |
      server {
          listen 80;
          server_name {{ trigger_live_domain }};
          return 301 https://$host$request_uri;
      }
  notify: reload nginx

- name: Enable nodejs HTTPS vhost
  file:
    src: /etc/nginx/sites-available/nodejs-ssl.conf
    dest: /etc/nginx/sites-enabled/nodejs-ssl.conf
    state: link
  notify: reload nginx

- name: Enable nodejs HTTP redirect vhost
  file:
    src: /etc/nginx/sites-available/nodejs-http.conf
    dest: /etc/nginx/sites-enabled/nodejs-http.conf
    state: link
  notify: reload nginx

- name: Get webhook configuration from Vault
  uri:
    url: "{{ remote_vault_address }}/v1/secret/data/{{ item }}"
    method: GET
    headers:
      X-Vault-Token: "{{ remote_vault_token }}"
    return_content: yes
  register: webhook_config
  loop:
    - jenkins_webhook
  loop_control:
    label: "{{ item }}"

- name: Set credential facts from Vault
  set_fact:
    webhook_url: "{{ (webhook_config.results | selectattr('item', 'equalto', 'jenkins_webhook') | first).json.data.data.webhook_url }}"
    trigger_domain: "{{ (webhook_config.results | selectattr('item', 'equalto', 'jenkins_webhook') | first).json.data.data.trigger_domain }}"
