---
# Playbook to install Helm and Prometheus on a Kubernetes cluster
- name: Add Helm signing key
  ansible.builtin.apt_key:
    url: https://baltocdn.com/helm/signing.asc
    state: present
  register: helm_key_result
  until: helm_key_result is succeeded
  retries: 3
  delay: 5

- name: Install apt-transport-https
  ansible.builtin.apt:
    name: apt-transport-https
    state: present
    update_cache: yes

- name: Add Helm repository
  ansible.builtin.apt_repository:
    repo: "deb https://baltocdn.com/helm/stable/debian/ all main"
    state: present
    filename: helm-stable-debian

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes

- name: Install Helm
  ansible.builtin.apt:
    name: helm
    state: present
  register: helm_install_result

# Verify Helm is installed correctly
- name: Verify Helm installation
  ansible.builtin.command: helm version
  register: helm_version
  changed_when: false
  failed_when: helm_version.rc != 0

# Add Prometheus Helm repository
- name: Add Prometheus Helm repository
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: https://prometheus-community.github.io/helm-charts
  register: helm_repo_add

# Update Helm repositories
- name: Update Helm repositories
  ansible.builtin.command: helm repo update
  changed_when: true
  register: helm_repo_update
  until: helm_repo_update is succeeded
